---
# possibly saved as pre-servers/roles/redis-cluster/tasks
- name: 检查solr是否已安装
  shell: ls /home/{{user_home}}/apps/solr-5.4.0
  register: solr_result
  ignore_errors: True
  
- name: 检查zookeeper是否已安装
  shell: ls /home/{{user_home}}/apps/zookeeper-3.4.6
  register: zookeeper_result
  ignore_errors: True
  
- name: 拷贝solr + zookeeper安装包
  copy: src=solr-zookeeper/ dest=/home/{{user_home}}/tools/ owner={{user_home}} group={{user_home}} mode=0700
  when: solr_result is failed or zookeeper_result is failed
  
- name: 解压solr
  shell: cd /home/{{user_home}}/tools && tar zxvf solr-5.4.0.tgz -C /home/{{user_home}}/apps
  when: solr_result is failed
  
- name: 解压zookeeper
  shell: cd /home/{{user_home}}/tools && tar zxvf zookeeper-3.4.6.tar.gz -C /home/{{user_home}}/apps
  when: zookeeper_result is failed

- name: 新建文件夹/home/{{user_home}}/datas/solr_home
  file: dest=/home/{{user_home}}/datas/solr_home state=directory owner={{user_home}} group={{user_home}} recurse=yes
  
- name: 新建文件夹/home/{{user_home}}/datas/zookeeper/data
  file: dest=/home/{{user_home}}/datas/zookeeper/data state=directory owner={{user_home}} group={{user_home}} recurse=yes
  
- name: 新建文件夹/home/{{user_home}}/datas/zookeeper/logs
  file: dest=/home/{{user_home}}/datas/zookeeper/logs state=directory owner={{user_home}} group={{user_home}} recurse=yes

- name: 拷贝zoo.cfg到目录/home/{{user_home}}/apps/zookeeper-3.4.6/conf/zoo.cfg
  template: src=zoo.cfg.tem dest=/home/{{user_home}}/apps/zookeeper-3.4.6/conf/zoo.cfg owner={{user_home}} group={{user_home}} mode=0644
  when: zookeeper_result is failed
  
- name: 拷贝solr.xml到目录/home/{{user_home}}/datas/solr_home/solr.xml
  template: src=solr.xml.tem dest=/home/{{user_home}}/datas/solr_home/solr.xml owner={{user_home}} group={{user_home}} mode=0644
  when: solr_result is failed
  
- name: check zookeeper服务是否已运行
  shell: ps axu|grep "zookeeper"|grep -v 'grep'
  register: zookeeper_server_result
  ignore_errors: True
  
- name: 配置zookeeper /home/{{user_home}}/datas/zookeeper/data/myid
  shell: echo $HOSTNAME |grep -Eo '[0-9]+' > /home/{{user_home}}/datas/zookeeper/data/myid
  when: zookeeper_server_result is failed

- name: 启动zookeeper
  shell: /home/{{user_home}}/apps/zookeeper-3.4.6/bin/zkServer.sh start
  when: zookeeper_server_result is failed